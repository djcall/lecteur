<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mini Scanner (clic requis)</title>
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<style>
  :root{--accent:#2563eb;--bg:#000;--fg:#fff}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:Segoe UI,Arial,sans-serif}
  .wrap{max-width:420px;margin:30px auto;text-align:center;padding:12px}
  h1{font-size:18px;margin:6px 0 14px}
  #qr-reader{width:220px;height:170px;margin:0 auto;border:2px solid var(--accent);border-radius:10px;display:none;overflow:hidden}
  .controls{display:flex;gap:8px;justify-content:center;margin-top:12px}
  button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,.08)}
  #status{margin-top:8px;font-size:13px;color:#ddd}
  small.note{display:block;margin-top:10px;color:#bbb}
</style>
</head>
<body>
<div class="wrap">
  <h1>üì¶ Mini Scanner ‚Äî clique pour d√©marrer</h1>

  <div id="qr-reader" aria-hidden="true"></div>

  <div class="controls">
    <button id="startBtn">üì∑ Scanner</button>
    <button id="stopBtn" class="ghost" style="display:none">‚èπ Arr√™ter</button>
  </div>

  <div id="status">Pr√™t. Clique sur <strong>Scanner</strong>.</div>
  <small class="note">N√©cessite HTTPS et autorisation cam√©ra. Pr√©f√©rer Chrome / Edge.</small>
</div>

<script>
  const targetUrl = "http://192.168.0.249/recepv4/scanner.html"; // <-- ton serveur local
  const readerEl = document.getElementById('qr-reader');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const status = document.getElementById('status');

  let scanner = null;
  let isRunning = false;

  function setStatus(text){
    status.textContent = text;
  }

  async function startScanner(){
    if(isRunning) return;
    setStatus('Demande d\'acc√®s cam√©ra...');
    // test getUserMedia rapide pour pouvoir afficher message pr√©cis en cas d'erreur
    try{
      await navigator.mediaDevices.getUserMedia({ video:true });
    }catch(err){
      console.error('getUserMedia failed', err);
      setStatus('Acc√®s cam√©ra refus√© ou indisponible. V√©rifie les permissions et HTTPS.');
      return;
    }

    readerEl.style.display = 'block';
    startBtn.style.display = 'none';
    stopBtn.style.display = 'inline-block';
    setStatus('En √©coute... pr√©sente un code devant la cam√©ra');

    scanner = new Html5Qrcode("qr-reader");
    isRunning = true;

    try{
      await scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 200, height: 150 }, disableFlip: false },
        decodedText => {
          // code lu
          setStatus('Code d√©tect√© ‚Äî redirection...');
          // stop propre puis redirection
          scanner.stop().then(()=>{
            isRunning = false;
            readerEl.style.display = 'none';
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            // envoie au serveur local
            window.location.href = `${targetUrl}?tracking=${encodeURIComponent(decodedText)}`;
          }).catch(err=>{
            console.error('Erreur stop apr√®s d√©tection', err);
            // tentative de redirection quand m√™me
            window.location.href = `${targetUrl}?tracking=${encodeURIComponent(decodedText)}`;
          });
        },
        errorMessage => {
          // erreurs bruyantes ignor√©es
        }
      );
    }catch(err){
      console.error('Html5Qrcode start error', err);
      setStatus('Impossible de d√©marrer le scanner. Voir console.');
      readerEl.style.display = 'none';
      startBtn.style.display = 'inline-block';
      stopBtn.style.display = 'none';
      isRunning = false;
    }
  }

  async function stopScanner(){
    if(!isRunning || !scanner) { setStatus('Scanner arr√™t√©'); return; }
    setStatus('Arr√™t du scanner...');
    try{
      await scanner.stop();
    }catch(err){
      console.warn('Erreur lors de l\'arr√™t', err);
    }
    scanner.clear(); // lib√®re le DOM interne
    scanner = null;
    isRunning = false;
    readerEl.style.display = 'none';
    startBtn.style.display = 'inline-block';
    stopBtn.style.display = 'none';
    setStatus('Scanner arr√™t√©.');
  }

  startBtn.addEventListener('click', startScanner);
  stopBtn.addEventListener('click', stopScanner);

  // accessibilit√©: d√©marrer aussi sur "Enter" si focus sur start
  startBtn.addEventListener('keyup', e => { if(e.key === 'Enter') startScanner(); });
</script>
</body>
</html>

